@{
    Layout = null;
    var solicitud = ViewBag.Solicitud as CapaModelo.Solicitud;
    bool isButtonEnabled = @solicitud.NombreEstado == "AL asignado" ||
                               @solicitud.NombreEstado == "En curso" ||
                               (@solicitud.NombreEstado == "Finalizado" && @solicitud.NombreFase == "En redaccion respuesta") ||
                               (@solicitud.NombreEstado == "Rechazado" && @solicitud.NombreFase == "Doc Respuesta Rechazado");
    bool isButtonEnabled2 = @solicitud.NombreFase == "Admitido" || (@solicitud.NombreEstado == "Rechazado" && @solicitud.NombreFase == "Doc Respuesta Rechazado");
    bool isButtonEnabled3 = @solicitud.NombreFase == "Doc Respuesta Aprobado";
    var isRedaccionDeRespuesta = solicitud.NombreFase == "En Redaccion respuesta";

}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Trámite Documentario</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.5.0/font/bootstrap-icons.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.validation/1.19.3/jquery.validate.min.js"></script>

    <!-- SweetAlert CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- SweetAlert JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Incluye Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Incluye Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</head>
<body>
    <style>
        .bg-primary-dark {
            background-color: #1d3872; /* Un azul más oscuro */
        }

        .btn-primary-dark {
            background-color: #1d3872; /* Un azul más oscuro */
            color: white; /* Color de la letra */
            border-color: #1d3872; /* Color del borde */
        }

        .nav-link-custom {
            background-color: #1d3872; /* Fondo azul oscuro */
            color: white; /* Letra blanca */
        }

        .icon-button {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 24px;
            color: #007bff;
        }

            .icon-button:hover {
                color: #0056b3;
            }

        #btnArchivar {
            display: none; /* Ocultar el botón inicialmente */
        }
    </style>

    <div class="container mt-4">
        <div class="card">
            <div class="card-header bg-primary-dark text-white d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <a href="/Solicitudes/Inicio" class="me-4">
                        <i class="bi bi-house-door" style="cursor: pointer; font-size: 2.0rem; color: white;"></i>
                    </a>
                    <span>Sistema de trámite documentario - Detalle Expediente @solicitud.Titulo</span>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-primary text-white me-4" id="btnArchivar" style="width: 8rem; background-color: #41bfa0;" @(isButtonEnabled3 ? "" : "disabled")>
                        Archivar
                    </button>
                    <a href="javascript:void(0);" onclick="location.reload();" class="me-4">
                        <i class="bi bi-arrow-repeat" style="cursor: pointer; font-size: 2.0rem; color: white;"></i>
                    </a>
                    <a href="javascript:void(0);" onclick="window.history.back();" class="me-4">
                        <i class="bi bi-arrow-left-circle" style="cursor: pointer; font-size: 2.0rem; color: white;"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Tabs Navigation -->
                <div class="d-flex align-items-center">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">Datos Generales</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="areas-tab" data-bs-toggle="tab" data-bs-target="#areas" type="button" role="tab" aria-controls="areas" aria-selected="false">Áreas Externas</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="document-tab" data-bs-toggle="tab" data-bs-target="#document" type="button" role="tab" aria-controls="document" aria-selected="false">Documento Enviado</button>
                        </li>
                    </ul>
                    <div class="p-0 mb-0 border d-flex justify-content-center" style="margin-left: 34rem; width: 15rem; background-color: #41bfa0; ">
                        <p class="text-white">@solicitud.NombreFase/ @solicitud.NombreEstado</p>
                    </div>
                </div>
                <hr style="border: 1px solid blue; margin: 1rem 0;">

                <!-- Tabs Content -->
                <div class="tab-content mt-3" id="myTabContent">
                    <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                        <div class="row g-3">
                            <!-- Primera Cuadrícula: Parte Izquierda -->
                            <div class="col-md-5 me-0.5">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <strong>Nro Documento:</strong>
                                        <div>@solicitud.NumeroDoc</div>
                                    </div>
                                    <div class="col-md-12">
                                        <strong>Asunto:</strong>
                                        <div>@solicitud.Asunto</div>
                                    </div>
                                    <div class="col-md-12">
                                        <strong>Referencia:</strong>
                                        <textarea class="form-control" readonly rows="5">@solicitud.Referencia</textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <strong>Ubicación:</strong>
                                        <div>Piso: @solicitud.Piso / Estante: @solicitud.Estante / File: @solicitud.File</div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="row g-0">
                                            <div class="col-md-6">
                                                <strong>Fecha registro:</strong>
                                                <div>@solicitud.FechaRegistro.ToString("dd/MM/yyyy")</div>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Fecha recepción:</strong>
                                                <div>@solicitud.FechaRecepcion.ToString("dd/MM/yyyy")</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <strong>Analista legal:</strong>
                                        <div>@solicitud.AnalistaNombre</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Segunda Cuadrícula: Parte Derecha -->
                            <div class="col-md-6 ms-5">
                                <div class="row g-3">
                                    <!-- Línea de Fechas y Plazo -->
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label for="fechaVencimientoExterno" class="form-label">F. Vencimiento Externo:</label>
                                            <input type="date" class="form-control form-control-sm" id="fechaVencimientoExterno" @(isButtonEnabled ? "" : "disabled")>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="fechaVencimientoInterno" class="form-label">F. Vencimiento Interno:</label>
                                            <input type="date" class="form-control form-control-sm" id="fechaVencimientoInterno" @(isButtonEnabled ? "" : "disabled")>
                                        </div>
                                        <div class="col-md-4 ">
                                            <label for="plazo" class="form-label text-nowrap">Plazo atención (días calendario):</label>
                                            <div class="d-flex align-items-center">
                                                <input type="text" class="form-control form-control-sm" id="plazo" placeholder="@solicitud.PlazoAtc" @(isButtonEnabled ? "" : "disabled")>
                                                <button type="button" class="btn btn-link p-0 ms-2" id="btnmodificarDetalle" onclick="modificarDetalle()" @(isButtonEnabled ? "" : "disabled")>
                                                    <i class="bi bi-save" style="cursor: pointer;"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Información de Empresa, Institución y Tipo Documento -->
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <strong>Empresa:</strong>
                                            <div>@solicitud.NombreEmpresa</div>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Institución:</strong>
                                            <div>@solicitud.NombreInstitucion</div>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Tipo documento:</strong>
                                            <div>@solicitud.TipoDoc</div>
                                        </div>
                                    </div>

                                    <!-- Información de Formato, Proyecto y Fecha Emisión -->
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <strong>Formato:</strong>
                                            <div>@solicitud.NombreFormato</div>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Proyecto:</strong>
                                            <div>@solicitud.NombreProyecto</div>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Fecha Emisión:</strong>
                                            <div>@solicitud.FechaEmision.ToString("dd/MM/yyyy")</div>
                                        </div>
                                    </div>

                                    <!-- Información de Penalidad y Carta Enviada -->
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <strong>Penalidad:</strong>
                                            <div>@solicitud.Penalidad</div>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Nro Carta enviada:</strong>
                                            <div></div>
                                        </div>
                                    </div>
                                    <!-- Documentos Adjuntos -->
                                    <div class="col-md-12" style="height: 160px;">
                                        <strong>Documentos adjuntos:</strong>
                                        <ul class="list-unstyled ps-0 mt-2">
                                            @if (solicitud.NombresArchivos != null && solicitud.NombresArchivos.Count > 0 && solicitud.TipoArchivo != null && solicitud.TipoArchivo.Count == solicitud.NombresArchivos.Count)
                                            {
                                                for (int i = 0; i < solicitud.NombresArchivos.Count; i++)
                                                {
                                                    if (solicitud.TipoArchivo[i] == 0)
                                                    {
                                                        <li class="d-flex align-items-center">
                                                            <!-- Icono para descargar el archivo -->
                                                            <a href="@Url.Action("DescargarArchivo", "DetalleSolicitud", new { idSolicitud = solicitud.IdSolicitud, nombreArchivo = solicitud.NombresArchivos[i] })" target="_blank" class="me-3">
                                                                <i class="bi bi-download" style="font-size: 1.5rem; color: #007bff;"></i>
                                                            </a>
                                                            <!-- Nombre del archivo -->
                                                            <span class="me-2">@solicitud.NombresArchivos[i]</span>
                                                            <!-- Icono para mostrar el archivo en una vista -->
                                                            <a href="@Url.Action("MostrarArchivo", "DetalleSolicitud", new { idSolicitud = solicitud.IdSolicitud, nombreArchivo = solicitud.NombresArchivos[i] })" target="_blank" class="ms-5">
                                                                <i class="bi bi-eye" style="font-size: 1.5rem; color: #007bff;"></i>
                                                            </a>
                                                        </li>
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                <li>No hay documentos adjuntos.</li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="areas" role="tabpanel" aria-labelledby="areas-tab">
                        <div class="d-flex align-items-center mb-3">
                            <h7 class="me-3 mb-0">Agregar solicitud a área externa:</h7>
                            <button class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#agregarSolicitudModal" @(isButtonEnabled2 ? "" : "disabled")>
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-primary-dark me-2" id="btnEnviarAreas" style="margin-left: 14rem;" data-bs-toggle="modal" data-bs-target="#EnviarAreasExternasModal" disabled>Enviar Áreas</button>
                            <button class="btn btn-primary-dark me-2" id="btnCulminarFase" data-bs-toggle="modal" data-bs-target="#ConfirmarCierreFaseModal" style="margin-left: 2rem;" disabled>Culminar Fase</button>
                        </div>

                        <!-- Tabla -->
                        <table id="tablaSubsolicitudes" class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>A. Externa</th>
                                    <th>Comentarios</th>
                                    <th>Observación</th>
                                    <th>Comentarios A. Externa</th>
                                    <th>Responsable</th>
                                    <th>Fecha Solicitud / Fecha Respuesta</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>

                        <!-- Sección de documentos -->
                        <div class="col-md-12" style="height: 70px;">
                            <div class="d-flex align-items-center">
                                <strong>Documentos enviados:</strong>
                            </div>
                            <ul class="list-unstyled ps-0 mt-2">
                                @if (solicitud?.SubSolicitudes != null && solicitud.SubSolicitudes.Count > 0)
                                {
                                    for (int i = 0; i < solicitud.SubSolicitudes.Count; i++)
                                    {
                                        if (solicitud.SubSolicitudes[i]?.NombresArchivos != null)
                                        {
                                            for (int j = 0; j < solicitud.SubSolicitudes[i].NombresArchivos.Count; j++)
                                            {
                                                if (solicitud.SubSolicitudes[i].NombresArchivos[j] != null)
                                                {
                                                    <li class="d-flex" id="archivo-@i-@j" style="display: none;">
                                                        <!-- Icono para descargar el archivo -->
                                                        <a href="@Url.Action("DescargarArchivo", "DetalleSolicitud", new { idSolicitud = solicitud.IdSolicitud, nombreArchivo = solicitud.SubSolicitudes[i].NombresArchivos[j]})" target="_blank" class="me-3">
                                                            <i class="bi bi-download" style="font-size: 1.5rem; color: #007bff;"></i>
                                                        </a>
                                                        <!-- Nombre del archivo -->
                                                        <span class="me-2">@solicitud.SubSolicitudes[i].NombresArchivos[j]</span>
                                                        <!-- Icono para mostrar el archivo en una vista -->
                                                        <a href="@Url.Action("MostrarArchivo", "DetalleSolicitud", new { idSolicitud = solicitud.IdSolicitud, nombreArchivo = solicitud.SubSolicitudes[i].NombresArchivos[j] })" target="_blank" class="ms-5">
                                                            <i class="bi bi-eye" style="font-size: 1.5rem; color: #007bff;"></i>
                                                        </a>
                                                    </li>
                                                }
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    <li>No hay documentos adjuntos.</li>
                                }
                            </ul>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="document" role="tabpanel" aria-labelledby="document-tab">
                        <div class="d-flex flex-column mb-3">
                            <div class="d-flex align-items-center mb-3">
                                <h6 class="me-3 mb-0">Cargar carta emitida:</h6>
                                <button class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#cargaDoc">
                                    <i class="bi bi-file-earmark-plus" style="color: black; filter: grayscale(100%); cursor: pointer;"></i>
                                </button>                                <button class="btn btn-secondary " id="btnCulminarElaboracion" data-bs-toggle="modal" data-bs-target="#ConfirmarCulminarElaboracion" style="margin-left: 16rem;">
                                    Culminar carga
                                </button>
                            </div>
                            <div>
                                <ul class="list-unstyled ps-0 mt-2">
                                    @if (solicitud.NombresArchivos != null && solicitud.NombresArchivos.Count > 0 && solicitud.TipoArchivo != null && solicitud.TipoArchivo.Count == solicitud.NombresArchivos.Count)
                                    {
                                        for (int i = 0; i < solicitud.NombresArchivos.Count; i++)
                                        {
                                            if (solicitud.TipoArchivo[i] == 2)
                                            {
                                                <li class="d-flex align-items-center">
                                                    <!-- Icono para descargar el archivo -->
                                                    <a href="@Url.Action("DescargarArchivo", "DetalleSolicitud", new { idSolicitud = solicitud.IdSolicitud, nombreArchivo = solicitud.NombresArchivos[i] })" target="_blank" class="me-3">
                                                        <i class="bi bi-download" style="font-size: 1.5rem; color: #007bff;"></i>
                                                    </a>
                                                    <!-- Nombre del archivo -->
                                                    <span class="me-2">@solicitud.NombresArchivos[i]</span>
                                                    <!-- Icono para mostrar el archivo en una vista -->
                                                    <a href="@Url.Action("MostrarArchivo", "DetalleSolicitud", new { idSolicitud = solicitud.IdSolicitud, nombreArchivo = solicitud.NombresArchivos[i] })" target="_blank" class="ms-5">
                                                        <i class="bi bi-eye" style="font-size: 1.5rem; color: #007bff;"></i>
                                                    </a>
                                                    <a href="javascript:void(0);" onclick="eliminarArchivo('@solicitud.NombresArchivos[i]',this)" class="ms-3">
                                                        <i class="bi bi-trash" style="font-size: 1.5rem; color: red;"></i>
                                                    </a>
                                                </li>
                                            }
                                        }
                                    }
                                    else
                                    {
                                        <li>No hay documentos adjuntos.</li>
                                    }
                                </ul>
                            </div>
                        </div>

                        <hr style="border: 1px solid blue; margin-top: 6rem; margin-bottom: 1rem;">
                        <div class="d-flex align-items-center mb-3">
                            <h9 class="me-3 mb-0">Agregar Aprobador : </h9>
                            <button class="btn btn-link p-0" data-bs-toggle="modal">
                                <i class="fas fa-plus" data-bs-toggle="modal" data-bs-target="#AnadirAprobadoresJefes"></i>
                            </button>
                            <button class="btn btn-secondary " id="btnEnviarAprobacion" data-bs-toggle="modal" data-bs-target="#EnivarAprobacionModal" style="margin-left: 19rem;">
                                Solicitar Aprobacion
                            </button>
                        </div>
                        <table id="tablaSubsolicitudesJefe" class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Nivel</th>
                                    <th>Aprobador</th>
                                    <th>Comentarios Solicitante</th>
                                    <th>Estado</th>
                                    <th>Comentarios Aprobador</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="cargaDoc" tabindex="-1" aria-labelledby="cargaDocLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="background-color: #41bfa0;">
                <div class="modal-header" style="color: white;">
                    <h5 class="modal-title" id="uploadModalLabel">Cargar documentos:</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 border rounded p-3" style="background-color: white;">
                        <div class="file-upload mb-3">
                            <span id="file-status" class="small">There is nothing attached.</span>
                            <input type="file" id="file-input" style="display: none;" multiple>
                            <div>
                                <a class="attach-file small" id="attach-file" style="cursor: pointer; color: black; text-decoration: none;">
                                    <i class="bi bi-paperclip"></i> Attach file
                                </a>
                            </div>
                            <div id="file-list" class="mt-2"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control small" id="comments" placeholder="Ingrese comentarios del envío" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="confirmCargarDoc3" onclick='cargarDoc3()' disabled>Aceptar</button>
                    <button class="btn btn-primary" data-bs-dismiss="modal" id="cancel-btn" style="background-color: #1d3872">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="AnadirAprobadoresJefes" tabindex="-1" aria-labelledby="cargaDocLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="background-color: #41bfa0;">
                <div class="modal-header" style="color: white;">
                    <h5 class="modal-title" id="selectApproverLabel">Seleccione a la persona que aprobará el documento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="approverDropdown1" class="form-label"></label>
                        <select id="approverDropdown" class="form-select">
                            <option selected disabled>Seleccione una opción</option>
                            @foreach (var aprobadores in ViewBag.Aprobadores)
                            {
                                <option value="@aprobadores.IdUsuario">@aprobadores.Nombres</option>
                            }
                            <!--<option value="1">Hegel Espinoza</option>
                            <option value="2">Jorge Arakaki</option>
                            <option value="3">Santiago Moquillaza</option>-->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="btnAgregarSubSolicitudJefe" type="button" data-bs-dismiss="AgregarSubSolicitudJefe" onclick="AgregarSubSolicitudJefe()">Aceptar</button>
                    <button class="btn btn-primary" data-bs-dismiss="modal" id="cancel-btn" style="background-color: #1d3872;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<!-- Modal -->
<div class="modal fade" id="agregarSolicitudModal" tabindex="-1" aria-labelledby="agregarSolicitudModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="agregarSolicitudModalLabel">Agregar Solicitudes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Contenido del modal -->
                <div class="container">
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Área externa :</strong>
                        </div>
                        <div class="col-6">
                            <strong>Responsable área externa :</strong>
                        </div>
                    </div>
                </div><!-- Contenedor con scroll -->
                <div class="container" style="max-height: 300px; overflow-y: auto;">
                    @foreach (var areaExterna in ViewBag.AreaExterna)
                    {
                        <div class="row mb-2">
                            <div class="col-6">
                                <input type="checkbox" id="@areaExterna.IdAreaExterna" />
                                <label for="@areaExterna.IdAreaExterna">@areaExterna.Nombre</label>
                            </div>
                            <div class="col-6">
                                <select class="form-select" id="persona_@areaExterna.IdAreaExterna">
                                    <option value="">Buscar persona</option>
                                    @foreach (var persona in ViewBag.personasPorAreaExterna[@areaExterna.IdAreaExterna])
                                    {
                                        <option value="@persona.IdUsuario">@persona.Nombres</option>
                                    }
                                </select>
                            </div>
                        </div>
                    }
                    <!-- Contenido deslizable -->
                    <!--<div class="row mb-2">
                        <div class="col-6">
                            <input type="checkbox" id="gafConta" />
                            <label for="gafConta">GAF-CONTA</label>
                        </div>
                        <div class="col-6">
                            <select class="form-select" id="gafContaPersona">
                                <option value="">Buscar persona</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="checkbox" id="gafRrhh" />
                            <label for="gafRrhh">GAF-RRHH</label>
                        </div>
                        <div class="col-6">
                            <select class="form-select" id="gafRrhhPersona">
                                <option value="">Buscar persona</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="checkbox" id="gafFin" />
                            <label for="gafFin">GAF-FIN</label>
                        </div>
                        <div class="col-6">
                            <select class="form-select" id="gafFinPersona">
                                <option value="">Buscar persona</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="checkbox" id="opepmo" />
                            <label for="gafOpepmo">OPE-PMO</label>
                        </div>
                        <div class="col-6">
                            <select class="form-select" id="gafOpepmoPersona">
                                <option value="">Buscar persona</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="checkbox" id="opeope" />
                            <label for="gafOpeope">OPE-OPE</label>
                        </div>
                        <div class="col-6">
                            <select class="form-select" id="gafOpeopePersona">
                                <option value="">Buscar persona</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="checkbox" id="dndneg" />
                            <label for="gafDndneg">DN-DNEG</label>
                        </div>
                        <div class="col-6">
                            <select class="form-select" id="gafDndnegPersona">
                                <option value="">Buscar persona</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="checkbox" id="glsstma" />
                            <label for="gafGlsstma">GL-SSTMA</label>
                        </div>
                        <div class="col-6">
                            <select class="form-select" id="gafGlsstmaPersona">
                                <option value="">Buscar persona</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="checkbox" id="opecalidad" />
                            <label for="gafOpecalidad">OPE-CALIDAD</label>
                        </div>
                        <div class="col-6">
                            <select class="form-select" id="gafOpecalidadPersona">
                                <option value="">Buscar persona</option>
                                <option value="1">Jose Villalobos</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="checkbox" id="opeored" />
                            <label for="gafOpeored">OPE-O.RED</label>
                        </div>
                        <div class="col-6">
                            <select class="form-select" id="gafOpeoredPersona">
                                <option value="">Buscar persona</option>
                                <option value="1">Iris Huamani</option>
                                <option value="2">Marcos Limo</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="checkbox" id="ggeneral" />
                            <label for="ggeneral">G-GENERAL</label>
                        </div>
                        <div class="col-6">
                            <select class="form-select" id="ggeneralPersona">
                                <option value="">Buscar persona</option>
                                <option value="1">Hegel Espinoza</option>
                                <option value="2">Jorge Arakaki</option>
                                <option value="2">Juan Zegarra</option>
                            </select>
                        </div>
                    </div>-->
                </div>
                <div class="row mt-3">
                    <textarea class="form-control" rows="3" placeholder="Ingrese su solicitud para el área externa." id="comentario"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnAgregarSubSolicitudes" type="button" class="btn btn-primary " data-bs-dismiss="AgregarSubSolicitudes" onclick="AgregarSubSolicitudes()">Aceptar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #ff5b5b;">
            <div class="modal-body text-center text-white">
                <p>¿Desea eliminar el registro?</p>
            </div>
            <div class="modal-footer justify-content-center" style="border-top: none;">
                <button class="btn" style="background-color: #2d2f33; color: white; border-radius: 5px;" id="confirmDeleteButton" onclick='borrarSubSolicitudJefe()'>Aceptar</button>
                <button class="btn" style="background-color: #2d2f33; color: white; border-radius: 5px;" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmDeleteModal2" tabindex="-1" aria-labelledby="confirmDeleteModal2Label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #ff5b5b;">
            <div class="modal-body text-center text-white">
                <p>¿Desea eliminar el registro?</p>
            </div>
            <div class="modal-footer justify-content-center" style="border-top: none;">
                <button class="btn" style="background-color: #2d2f33; color: white; border-radius: 5px;" id="confirmDeleteButton2" onclick='borrarSubSolicitud()'>Aceptar</button>
                <button class="btn" style="background-color: #2d2f33; color: white; border-radius: 5px;" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación -->
<div class="modal fade" id="ConfirmarCierreFaseModal" tabindex="-1" aria-labelledby="ConfirmarCierreFaseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                ¿ Desea culminar la fase e iniciar la elaboración de respuesta ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="culminarFase">Aceptar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación Aprobacion -->
<div class="modal fade" id="EnivarAprobacionModal" tabindex="-1" aria-labelledby="EnivarAprobacionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                ¿ Desea enviar el documento para su revision y aprobacion?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="aceptarButtonEnviarAprobacion">Aceptar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="DocObservados" tabindex="-1" aria-labelledby="DocObservadosModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #e74c3c; color: white; padding: 20px;">
            <div class="modal-body text-center">
                <p>¿Desea observar los documentos enviados?</p>
                <textarea class="form-control" id="observacionText" placeholder="Ingrese el motivo de la observación" rows="4"></textarea>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-dark" id="aceptarButtonEnviarObservaciones">Aceptar</button>
                <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="ConfirmarCulminarElaboracion" tabindex="-1" aria-labelledby="ConfirmarCulminarElaboracionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                ¿ Desea culminar la elaboración del documento de respuesta ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="culminarElaboracion">Aceptar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="EnviarAreasExternasModal" tabindex="-1" aria-labelledby="EnviarAreasExternasModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                ¿ Desea enviar a areas externas el expediente ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="aceptarButton" onclick="enviarAreas()">Aceptar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>



<script type="text/javascript">
        $.extend({ MisUrls: { url: {}, urls: function (a) { $.extend($.MisUrls.url, a); } } });


        //CONTROLADOR Solicitudes
        $.MisUrls.urls({ _ObtenerSolicitudes: '@Url.Action("Obtener", "Solicitudes")' });
        $.MisUrls.urls({ _GuardarSolicitud: '@Url.Action("Guardar", "Solicitudes")' });
        $.MisUrls.urls({ _ObtenerSolicitudesPorParametros: '@Url.Action("ObtenerPorExpDoc", "Solicitudes")' });
        $.MisUrls.urls({ _CargarDocSubSolicitudesJefes: '@Url.Action("CargarDocSolicitudesJefes", "Solicitudes")' });

        //CONTROLADOR DetalleSolicitud
        $.MisUrls.urls({ _ObtenerSolicitud: '@Url.Action("Obtener", "DetalleSolicitud")' });
        $.MisUrls.urls({ _ModificarSolicitudes: '@Url.Action("Modificar", "DetalleSolicitud")' });
        $.MisUrls.urls({ _ModificarSolicitudesDetalle: '@Url.Action("ModificarDetalle", "DetalleSolicitud")' });

        //CONTROLADOR SubSolicituddes

        $.MisUrls.urls({ _GuardarSubSolicitud: '@Url.Action("Guardar", "SubSolicitud")' });
        $.MisUrls.urls({ _ObtenerSubSolicitud: '@Url.Action("Obtener", "SubSolicitud")' });
        $.MisUrls.urls({ _EliminarSubSolicitud: '@Url.Action("Eliminar", "SubSolicitud")' });
        $.MisUrls.urls({ _EnviarAreas: '@Url.Action("EnviarAreas", "SubSolicitud")' });
        $.MisUrls.urls({ _ModificarEstadoSubSolicitudValidado: '@Url.Action("ModificarEstadoSubSolicitudValidado", "SubSolicitud")' });


        //CONTROLADOR SubSolicitudesJefes:

        $.MisUrls.urls({ _GuardarSubSolicitudJefe: '@Url.Action("Guardar", "SubSolicitudJefe")' });
        $.MisUrls.urls({ _ObtenerSubSolicitudJefe: '@Url.Action("Obtener", "SubSolicitudJefe")' });
        $.MisUrls.urls({ _EliminarSubSolicitudJefe: '@Url.Action("Eliminar", "SubSolicitudJefe")' });

        //lenguaje español datatable
        $.MisUrls.urls({
            Url_datatable_spanish: '@Url.Content("~/content/plugins/datatables/js/datatable_spanish.json")'
        });
</script>

<script>

    function modificarDetalle() {


        var request = {
            NumeroDoc: numeroDoc,
            FechaExterna: document.getElementById('fechaVencimientoExterno').value ? document.getElementById('fechaVencimientoExterno').value : null,
            FechaInterna: document.getElementById('fechaVencimientoInterno').value ? document.getElementById('fechaVencimientoInterno').value : null,
            Plazo: document.getElementById('plazo').value ? document.getElementById('plazo').value : null
        };

        console.log(request);

        jQuery.ajax({
            url: $.MisUrls.url._ModificarSolicitudesDetalle, // Asegúrate de que esta URL sea correcta
            type: "POST",
            data: JSON.stringify(request),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                if (data.OperacionExitosa) {
                    // Recargar la página después de guardar
                    location.reload();
                } else {
                    swal("Mensaje", "No se pudo guardar los cambios", "warning");
                }
            },
            error: function (error) {
                console.log(error);
            },
            beforeSend: function () {
                // agregar lógica aquí si necesitas hacer algo antes de enviar la solicitud
            }
        });
    }

    //actualizarTabla();

    // Definir una variable JavaScript con el valor de @solicitud.NumeroDoc
    var idSolicitud = '@solicitud.IdSolicitud'
    var fase='@solicitud.NombreFase'
    var titulo = '@solicitud.Titulo'
    var numeroDoc = '@solicitud.NumeroDoc';
    let selectedFiles = [];

    function checkFormValidity() {
        var fileInput = document.getElementById('file-input').files.length > 0;
        var comments = document.getElementById('comments').value.trim() !== '';
        document.getElementById('confirmCargarDoc3').disabled = !(fileInput && comments);
    }
    $(document).ready(function () {
        // Verificar y mostrar archivos cuando se selecciona el tab "Datos Generales"

        $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            var target = $(e.target).attr("data-bs-target");
            if (target === "#general") {
                verificarYMostrarArchivos2();
            } else if (target === "#areas") {
                verificarYMostrarArchivos();
            } else if (target === "#document") {
                // Abrir el selector de archivos al hacer clic en el enlace "Attach file"
                $('#attach-file').click(function () {
                    $('#file-input').click();
                });

                $('#file-input').change(function () {
                    const files = $(this)[0].files;
                    const fileList = $('#file-list');
                    fileList.empty();
                    //selectedFiles = [];

                    for (let i = 0; i < files.length; i++) {
                        selectedFiles.push(files[i]);
                    }
                    checkFormValidity();

                    for (let i = 0; i < selectedFiles.length; i++) {
                        console.log("Archivo " + (i + 1) + ": " + selectedFiles[i].name + ", ContentType: " + selectedFiles[i].type);
                    }


                    if (selectedFiles.length > 0) {
                        $('#file-status').text(selectedFiles.length + ' file(s) attached.');
                        for (let i = 0; i < selectedFiles.length; i++) {
                            const file = selectedFiles[i];
                            const fileItem = $('<div class="file-item"></div>').text(file.name);
                            const removeButton = $('<button class="btn btn-sm btn-danger ms-2">Remove</button>').click(function () {
                                removeFile(i);
                            });
                            fileItem.append(removeButton);
                            fileList.append(fileItem);
                        }
                    } else {
                        $('#file-status').text('There is nothing attached.');
                    }
                    $('#comments').on('input', function () {
                        checkFormValidity();
                    });
                });
                function removeFile(index) {
                    selectedFiles.splice(index, 1);
                    const fileList = $('#file-list');
                    fileList.empty();

                    if (selectedFiles.length > 0) {
                        $('#file-status').text(selectedFiles.length + ' file(s) attached.');
                        for (let i = 0; i < selectedFiles.length; i++) {
                            const file = selectedFiles[i];
                            const fileItem = $('<div class="file-item"></div>').text(file.name);
                            const removeButton = $('<button class="btn btn-sm btn-danger ms-2">Remove</button>').click(function () {
                                removeFile(i);
                            });
                            fileItem.append(removeButton);
                            fileList.append(fileItem);
                        }
                    } else {
                        $('#file-status').text('There is nothing attached.');
                    }
                }
                $('#comments').on('input', function () {
                    checkFormValidity();
                });
            }
            $('#aceptarButtonEnviarAprobacion').click(function() {
                var idSolicitud = '@solicitud.IdSolicitud'; // Obtén el ID de la solicitud

                $.ajax({
                    url: '@Url.Action("EnviarSolicitudDeAprobacion", "SubSolicitudJefe")', // URL del método del controlador
                    type: 'POST',
                    data: { idSolicitud: idSolicitud },
                    success: function(data) {
                        if (data.OperacionExitosa) {
                            Swal.fire("Éxito", "La solicitud ha sido enviada para aprobación.", "success");
                            location.reload();
                        } else {
                            Swal.fire("Error", "No se pudo enviar la solicitud para aprobación.", "error");
                            location.reload();
                        }
                    },
                    error: function(error) {
                        Swal.fire("Error", "Ocurrió un error al enviar la solicitud para aprobación.", "error");
                    }
                });
            });
            $('#aceptarButton').click(function() {
                var idSolicitud = '@solicitud.IdSolicitud'; // Obtén el ID de la solicitud
                Swal.fire("Éxito", "La solicitud ha sido enviada para aprobación.", "success");
                location.reload();
            });
            $('#culminarFase').click(function() {
                var idSolicitud = '@solicitud.IdSolicitud'; // Obtén el ID de la solicitud
                $.ajax({
                    url: '@Url.Action("CambiarEstadoFaseSolicitud", "Solicitudes")', // URL del método del controlador
                    type: 'POST',
                    data: {
                        idSolicitud: idSolicitud,
                        estado: 0,
                        fase: 3,
                    },
                    success: function(data) {
                        if (data.OperacionExitosa) {
                            Swal.fire("Éxito", "Se cumino la fase correctamente", "success");
                            location.reload();
                        } else {
                            Swal.fire("Error", "No se pudo terminar la fase.", "error");
                            location.reload();
                        }
                    },
                });
            });


            $('#btnArchivar').click(function() {
                var idSolicitud = '@solicitud.IdSolicitud'; // Obtén el ID de la solicitud
                $.ajax({
                    url: '@Url.Action("CambiarEstadoFaseSolicitud", "Solicitudes")', // URL del método del controlador
                    type: 'POST',
                    data: {
                        idSolicitud: idSolicitud,
                        estado: 4,
                        fase: 1,
                    },
                    success: function(data) {
                        if (data.OperacionExitosa) {
                            Swal.fire("Éxito", "Se cumino la fase correctamente", "success");
                            location.reload();
                        } else {
                            Swal.fire("Error", "No se pudo terminar la fase.", "error");
                            location.reload();
                        }
                    },
                    error: function(error) {
                        Swal.fire("Error", "Ocurrió un error al enviar la solicitud para aprobación.", "error");
                    }
                });
            });



        });

        var activeTab = $('.nav-tabs .nav-link.active').attr('data-bs-target');
            if (activeTab === "#document") {
                $('#btnArchivar').show();
            } else {
                $('#btnArchivar').hide();
            }
        $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                var target = $(e.target).attr("data-bs-target");
                if (target === "#document") {
                    $('#btnArchivar').show();
                } else {
                    $('#btnArchivar').hide();
                }
        });
        actualizarTabla();
        actualizarTablaSubSolicitudesJefes();
        // Evento change para habilitar el botón "Aceptar"
        $('#approverDropdown').change(function() {
            var selectedValue = $(this).val();
            if (selectedValue) {
                $('#accept-btn').prop('disabled', false);
            } else {
                $('#accept-btn').prop('disabled', true);
            }
        });
        $('#confirmDeleteButton').click(borrarSubSolicitudJefe);

        $('#aceptarButtonEnviarObservaciones').click(function () {
            var idSubSolicitud = $(this).data('idSubSolicitud');
            var observacion = $('#observacionText').val();

            // Aquí puedes agregar la lógica para manejar la observación
            // Por ejemplo, puedes hacer una llamada AJAX para actualizar el estado en el servidor
            $.ajax({
                url: '@Url.Action("ModificarEstadoSubSolicitudObservado", "SubSolicitud")', // URL del método del controlador
                type: 'POST',
                data: JSON.stringify({ IdSubSolicitud: idSubSolicitud, Observacion: observacion, IdSolicitud:idSolicitud }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if (data.OperacionExitosa) {
                        Swal.fire("Éxito", "La observación ha sido registrada.", "success");
                        location.reload();
                    } else {
                        Swal.fire("Error", "No se pudo registrar la observación.", "error");
                    }
                },
                error: function (error) {
                    Swal.fire("Error", "Ocurrió un error al registrar la observación.", "error");
                }
            });

            $('#DocObservados').modal('hide');
        });
    });
    function checkTableRows() {
    var rowCount = $('#tablaSubsolicitudes tbody tr').length;
    var hasSinEnviar = false;

    $('#tablaSubsolicitudes tbody tr').each(function() {
        var estado = $(this).find('td').eq(6).text().trim(); // Asumiendo que la columna Estado es la séptima columna (índice 6)
        if (estado === 'Sin enviar') {
            hasSinEnviar = true;
            return false; // Salir del bucle each
        }
    });

    if (rowCount > 0 && hasSinEnviar) {
        $('#btnEnviarAreas').prop('disabled', false);
    } else {
        $('#btnEnviarAreas').prop('disabled', true);
    }
}

    function AgregarSubSolicitudes() {

            console.log("Validando...");

            // Arreglo para almacenar los objetos SubSolicitud
            var subSolicitudes = [];

            // Selecciona todos los checkboxes que están seleccionados
            $("input[type=checkbox]:checked").each(function () {
                var checkboxId = $(this).attr('id');
                var label = $('label[for="' + checkboxId + '"]').text();
                var selectId = 'persona_' + checkboxId;
                var selectedPerson = $('#' + selectId + ' option:selected').text();

                // Crea un objeto SubSolicitud y agrégalo al arreglo
                var subSolicitud = {
                    NombreAreaExterna: label,
                    NombreResponsable: selectedPerson,
                    IdSolicitud: idSolicitud,
                    Comentario: $("#comentario").val(),
                    TituloSolicitud: titulo,
                    IdCreadoPor: null
                };
                subSolicitudes.push(subSolicitud);
            });

            var request = {
                objetos: subSolicitudes
            };
            
            console.log(request);

            jQuery.ajax({
                url: $.MisUrls.url._GuardarSubSolicitud,
                type: "POST",
                data: JSON.stringify(request),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data.OperacionExitosa) {
                        actualizarTabla();
                        $('#agregarSolicitudModal').modal('hide');
                    } else {
                        Swal.fire("Mensaje", "No se pudo guardar los cambios", "warning");
                    }
                },
                error: function (error) {
                    console.log(error);
                },
                beforeSend: function () {
                    // agregar lógica aquí si necesitas hacer algo antes de enviar la solicitud
                }
            });

    }

    function AgregarSubSolicitudJefe() {

        console.log("Validando...");

        var selectedPerson = $('#approverDropdown option:selected').text(); // Obtén el texto del select
        var subSolicitudJefe = {
            NombreAprobador: selectedPerson, // Asigna el texto del select a NombreAprobador
            IdSolicitud: idSolicitud,
        };

        var request = {
            objeto: subSolicitudJefe
        };

        console.log(request);

        jQuery.ajax({
            url: $.MisUrls.url._GuardarSubSolicitudJefe,
            type: "POST",
            data: JSON.stringify(request),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                if (data.OperacionExitosa) {
                    actualizarTablaSubSolicitudesJefes();
                    $('#AnadirAprobadoresJefes').modal('hide');
                } else {
                    Swal.fire("Mensaje", "No se pudo guardar los cambios", "warning");
                }
            },
            error: function (error) {
                console.log(error);
            },
            beforeSend: function () {
                // agregar lógica aquí si necesitas hacer algo antes de enviar la solicitud
            }
        });

    }



    function formatDate(timestamp) {
        if (!timestamp) return '';
        var date = new Date(parseInt(timestamp.replace(/\/Date\((.*?)\)\//, '$1')));
        var day = ('0' + date.getDate()).slice(-2);
        var month = ('0' + (date.getMonth() + 1)).slice(-2);
        var year = date.getFullYear();
        return day + '/' + month + '/' + year;
    }
    function formatDate(date) {
        if (!date) {
            return "Pendiente Rpta";
        }
        return moment(date).format('DD/MM/YYYY');
    }
    function actualizarTabla() {
    $.ajax({
        url: $.MisUrls.url._ObtenerSubSolicitud, // Asegúrate de que esta URL sea correcta
        type: 'GET',
        data: { IdSolicitud: idSolicitud }, // Pasa el parámetro IdSolicitud
        dataType: "json",
        success: function (response) {
            console.log(response); // Depura la respuesta
            var subSolicitudes = response.data;
            var tbody = $("#tablaSubsolicitudes tbody");
            tbody.empty(); // Limpia el contenido actual de la tabla
            var allCulminado = true;
            subSolicitudes.forEach(function (SubSolicitud) {
                console.log(SubSolicitud.IdSubSolicitud)
                var row = "<tr>" +
                    "<td>" + SubSolicitud.NombreAreaExterna + "</td>" +
                    "<td>" + SubSolicitud.Comentario + "</td>" +
                    "<td>" + SubSolicitud.Observacion + "</td>" +
                    "<td>" + SubSolicitud.ComentarioAreaExterna + "</td>" +
                    "<td>" + SubSolicitud.NombreResponsable + "</td>" +
                    "<td>" + formatDate(SubSolicitud.FechaSolicitud) + " / " + formatDate(SubSolicitud.FechaRespuesta)+ "</td>" +
                    "<td><span class='badge bg-success'>" + SubSolicitud.NombreEstado + "</span>";
                    if (SubSolicitud.NombreEstado == 'Sin enviar') {
                        row += "<button class='btn btn-link btn-sm p-0 ms-4' data-bs-toggle='modal' data-bs-target='#confirmDeleteModal2' onclick='setDeleteId2(" + SubSolicitud.IdSubSolicitud + ")'><i class='bi bi-trash' style='color: #1d3872;'></i></button>";
                    } else if (SubSolicitud.NombreEstado == 'Culminado') {
                        row += "<button class='btn btn-link btn-sm p-0 ms-4'><i class='bi bi-hand-thumbs-up' style='color: green;' onclick='cambiarEstadoSubSolicitud(" + SubSolicitud.IdSubSolicitud + ")'></i></button>";
                        row += "<button class='btn btn-link btn-sm p-0 ms-2' data-bs-toggle='modal' data-bs-target='#DocObservados' onclick='setIdSubSolicitud(" + SubSolicitud.IdSubSolicitud + ")'><i class='bi bi-hand-thumbs-down' style='color: red;'></i></button>";                } else if (SubSolicitud.NombreEstado == 'Validado' && fase =='En Areas Externas' ){
                        allCulminado = false;
                    }
                    row += "</tr>";
                    "</tr>";
                    tbody.append(row);
            });
            checkTableRows();
            if (allCulminado) {
                $('#btnCulminarFase').prop('disabled', true);
            } else {
                $('#btnCulminarFase').prop('disabled', false);
            }
        },
        error: function (error) {
            console.log(error);
        },
        });
    }
    function cambiarEstadoSubSolicitud(idSubSolicitud) {
        $.ajax({
            url: $.MisUrls.url._ModificarEstadoSubSolicitudValidado,
            type: 'POST',
            data: JSON.stringify({ IdSubSolicitud: idSubSolicitud }), // Pasa el parámetro IdSubSolicitud
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (response.OperacionExitosa) {
                    // Actualiza la tabla después de cambiar el estado de la subsolicitud
                    actualizarTabla();
                } else {
                    console.error("Error al cambiar el estado de la subsolicitud:", response.message);
                }
            },
            error: function (error) {
                console.log(error);
            }
        });
    }

    function actualizarTablaSubSolicitudesJefes() {
        $.ajax({
            url: $.MisUrls.url._ObtenerSubSolicitudJefe, // Asegúrate de que esta URL sea correcta
            type: 'GET',
            data: { IdSolicitud: idSolicitud }, // Pasa el parámetro IdSolicitud
            dataType: "json",
            success: function (response) {
                console.log(response); // Depura la respuesta
                var subSolicitudesJefes = response.data;
                var tbody = $("#tablaSubsolicitudesJefe tbody");
                tbody.empty(); // Limpia el contenido actual de la tabla
                subSolicitudesJefes.forEach(function (SubSolicitudJefe) {
                    var comentario = SubSolicitudJefe.ComentarioSubSolicitudJefe ? SubSolicitudJefe.ComentarioSubSolicitudJefe : "Sin comentarios";
                    var row = "<tr>" +
                        "<td>" + SubSolicitudJefe.NombreAprobador + "</td>" +
                        "<td><span class='badge bg-warning'>" + SubSolicitudJefe.NombreEstado + "</span> ";
                        if (SubSolicitudJefe.NombreEstado !== "Aprobado" && SubSolicitudJefe.NombreEstado !== "Rechazado") {
                        row += "<button class='btn btn-link btn-sm p-0 ms-4' data-bs-toggle='modal' data-bs-target='#confirmDeleteModal' onclick='setDeleteId(" + SubSolicitudJefe.IdSubSolicitudJefe + ")'><i class='bi bi-trash fa-lg' style='color: #1d3872;'></i></button>";
                }
                row += "</td><td>" + comentario + "</td></tr>";
                "</tr>";
                    tbody.append(row);
                });
            },
            error: function (error) {
                console.log(error);
            }
        });
    }

    function setDeleteId(idSubSolicitudJefe) {
        // Guarda el ID de la subsolicitud que se va a borrar en un atributo data del botón de confirmación
        $('#confirmDeleteButton').data('id', idSubSolicitudJefe);
    }
    function setDeleteId2(idSubSolicitud) {
        // Guarda el ID de la subsolicitud que se va a borrar en un atributo data del botón de confirmación
        $('#confirmDeleteButton2').data('id', idSubSolicitud);
    }

    function borrarSubSolicitudJefe() {
        var idSubSolicitudJefe = $('#confirmDeleteButton').data('id');
        // Llama a la función eliminarSubSolicitudJefe para eliminar la subsolicitud jefe
        eliminarSubSolicitudJefe(idSubSolicitudJefe);
        // Después de borrar, cierra el modal y actualiza la tabla
        $('#confirmDeleteModal').modal('hide');
    }
    
    $('#confirmDeleteButton').off('click').on('click', borrarSubSolicitudJefe);
    function borrarSubSolicitud() {
        var idSubSolicitud = $('#confirmDeleteButton2').data('id');
        // Llama a la función eliminarSubSolicitudJefe para eliminar la subsolicitud jefe
        eliminarSubSolicitud(idSubSolicitud);
        // Después de borrar, cierra el modal y actualiza la tabla
        $('#confirmDeleteModal2').modal('hide');
    }

    function eliminarSubSolicitudJefe(idSubSolicitudJefe) {
    $.ajax({
        url: $.MisUrls.url._EliminarSubSolicitudJefe, // Asegúrate de que esta URL sea correcta
        type: 'DELETE',
        data: JSON.stringify({ IdSubSolicitudJefe: idSubSolicitudJefe }), // Pasa el parámetro IdSubSolicitudJefe
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (response) {
            if (response.OperacionExitosa) {
                // Actualiza la tabla después de eliminar la subsolicitud jefe
                actualizarTablaSubSolicitudesJefes();
            } else {
                console.error("Error al eliminar la subsolicitud jefe:", response.message);
            }
        },
        error: function (error) {
            console.log(error);
        }
    });
    }
    function eliminarSubSolicitud(idSubSolicitud) {
        $.ajax({
            url: $.MisUrls.url._EliminarSubSolicitud, // Asegúrate de que esta URL sea correcta
            type: 'DELETE',
            data: JSON.stringify({ IdSubSolicitud: idSubSolicitud }), // Pasa el parámetro IdSubSolicitudJefe
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (response.OperacionExitosa) {
                    // Actualiza la tabla después de eliminar la subsolicitud jefe
                    actualizarTabla();
                } else {
                    console.error("Error al eliminar la subsolicitud :", response.message);
                }
            },
            error: function (error) {
                console.log(error);
            }
        });
    }
    function enviarAreas() {
        var idSolicitud = '@solicitud.IdSolicitud'
        $.ajax({
            url: $.MisUrls.url._EnviarAreas, // Asegúrate de que esta URL sea correcta
            type: 'POST',
            data: JSON.stringify({ idSolicitud: idSolicitud }), // Pasa el parámetro idSubSolicitud y el nuevo estado
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (response.OperacionExitosa) {
                    // Actualiza la tabla después de cambiar el estado de la subsolicitud
                    actualizarTabla();
                    location.reload();
                } else {
                    console.error("Error al cambiar el estado de la subsolicitud:", response.message);
                }
            },
            error: function (error) {
                console.log(error);
            }
        });
    }

    function verificarYMostrarArchivos() {
        @if (solicitud?.SubSolicitudes != null)
        {
            for (int i = 0; i < solicitud.SubSolicitudes.Count; i++)
            {
                var idSubSolicitud = solicitud.SubSolicitudes[i]?.IdSubSolicitud;
                if (solicitud.SubSolicitudes[i]?.NombresArchivos != null)
                {
                    for (int j = 0; j < solicitud.SubSolicitudes[i].NombresArchivos.Count; j++)
                    {
                        var idSolicitud = solicitud.IdSolicitud;
                        var nombreArchivo = solicitud.SubSolicitudes[i].NombresArchivos[j];
                        <text>
                        $.ajax({
                            url: '@Url.Action("VerificarArchivo", "DetalleSolicitud")',
                            type: 'GET',
                            data: { idSolicitud: @idSolicitud, nombreArchivo: '@nombreArchivo', idSubSolicitud: @idSubSolicitud },
                            success: function (data) {
                                if (data) {
                                    $('#archivo-@i-@j').show();
                                } else {
                                    $('#archivo-@i-@j').hide();
                                }
                            },
                            error: function (error) {
                                console.log(error);
                            }
                        });
                        </text>
                    }
                }
            }
        }
    }
    function verificarYMostrarArchivos2() {
    @if (solicitud?.NombresArchivos != null)
        {
            for (int i = 0; i < solicitud.NombresArchivos.Count; i++)
            {
                var idSolicitud = solicitud.IdSolicitud;
                var nombreArchivo = solicitud.NombresArchivos[i];
                <text>
                $.ajax({
                    url: '@Url.Action("VerificarArchivo2", "DetalleSolicitud")',
                    type: 'GET',
                    data: { idSolicitud: @idSolicitud, nombreArchivo: '@nombreArchivo' },
                    success: function (data) {
                                console.log(data);
                                if (data) {
                                    $('#archivo2-@i').show();
                                } else {
                                    $('#archivo2-@i').hide();
                                }
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
                </text>
            }
        }
    }
    function cargarDoc3() {
        var comments = document.getElementById('comments').value;
        var files = document.getElementById('file-input').files;
        var formData = new FormData();
        formData.append('Comentario', comments);
        formData.append('IdSolicitud', idSolicitud);


        for (let i = 0; i < selectedFiles.length; i++) {
            formData.append("Archivos[" + i + "]", selectedFiles[i]);
            formData.append("NombresArchivos[" + i + "]", selectedFiles[i].name);
            formData.append("ContentTypes[" + i + "]", selectedFiles[i].type);
        }

        for (var pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }

        $.ajax({
            url: $.MisUrls.url._CargarDocSubSolicitudesJefes, // Asegúrate de que esta URL sea correcta
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (data) {
                if (data.OperacionExitosa) {
                    // Actualiza la tabla después de cambiar el estado de la subsolicitud
                    location.reload();
                } else {
                    console.error("Error al cambiar el estado de la subsolicitud:", response.message);
                }
            },
            error: function (error) {
                window.location.reload();
            }
        });

        $('#cargaDoc').modal('hide');

    }
    function eliminarArchivo(nombreArchivo, elemento) {
    var idSolicitud = '@solicitud.IdSolicitud'; // Obtén el ID de la solicitud
    Swal.fire({
        title: '¿Estás seguro?',
        text: "No podrás revertir esto",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, bórralo'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: '@Url.Action("EliminarArchivo", "DetalleSolicitud")', // URL del método del controlador
                type: 'POST',
                data: JSON.stringify({ idSolicitud: idSolicitud, nombreArchivo: nombreArchivo }),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data.OperacionExitosa) {
                        Swal.fire('Borrado', 'El archivo ha sido borrado.', 'success');
                        // Eliminar el elemento de la lista
                        $(elemento).closest('li').remove();
                    } else {
                        Swal.fire('Error', 'No se pudo borrar el archivo.', 'error');
                    }
                },
                error: function (error) {
                    Swal.fire('Error', 'Ocurrió un error al borrar el archivo.', 'error');
                }
            });
        }
    });
}
</script>

<script>
    $(document).ready(function () {

        // Cambiar el texto cuando se selecciona un archivo
        $('#file-input').change(function () {
            const fileName = $(this).val().split('\\').pop();
            $('#file-status').text(fileName || 'There is nothing attached.');
            $('#accept-btn').prop('disabled', fileName ? false : true);
        });

        // Acción para "Cancelar"
        $('#cancel-btn').click(function () {
            $('#file-input').val('');
            $('#file-status').text('There is nothing attached.');
            $('#comments').val('');
            $('#accept-btn').prop('disabled', true);
        });
    });
</script>
